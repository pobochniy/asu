name: Build

on: push
env:
  BUILD_DIR: buildfolder
  PUBLISH_DIR: publishfolder
  ARTIFACT_NAME: assembly
  DOTNET_VERSION: "6.0.300"
  
jobs:
  
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: checkout üõéÔ∏è
        uses: actions/checkout@v3
      - name: setup dotnet 
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: restore
        run: dotnet restore
      - name: build üèóÔ∏è
        run: dotnet build --no-restore -c Release -o ${{ env.BUILD_DIR }}
      - name: test ü¶ë
        run: dotnet test --no-restore --no-build -o ${{ env.BUILD_DIR }} ASU.sln
      - name: publish
        run: dotnet publish Api/Api.csproj -c Release -o ${{ env.PUBLISH_DIR }}
                  
  JetBrainsInspect:
    runs-on: ubuntu-latest
    env:
      DOTNET_VERSION: "6.0.300"
    steps:
      - name: checkout üôàüôâüôä
        uses: actions/checkout@v3
      - uses: actions/setup-dotnet@v2
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Install JetBrains GlobalTools
        run: dotnet tool install -g JetBrains.ReSharper.GlobalTools
      - name: Inspect
        env:
          Q_RESULTS: ".runs[].results[]"
          Q_CONTENTS: "{message:.message.text, file:.locations[0].physicalLocation.artifactLocation.uri, region: .locations[0].physicalLocation.region}"
          Q_NOTICE: '"::notice file=\(.file),line=\(.region.startLine),endLine=\(.region.endLine),col=\(.region.startColumn),endColumn=\(.region.endColumn)::\(.message)"'
        run: |
          mkdir inspect-out
          echo "::group::Inspect code"
          jb inspectcode --dotnetcoresdk=$DOTNET_VERSION -f=sarif -o=inspect-out/report.json ASU.sln
          echo "::endgroup::"
          jq "$Q_RESULTS | $Q_CONTENTS | $Q_NOTICE" -r inspect-out/report.json
    
    